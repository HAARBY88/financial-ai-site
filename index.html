<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Company Filing History Analysis</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    h1, h2 { color: #333; }
    form { margin-bottom: 20px; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 10px; }
    a { color: #0074D9; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Company Filing History Analysis</h1>

  <form id="companyForm">
    <label>
      Company Number: 
      <input type="text" name="company" placeholder="e.g. 08470590" required>
    </label>
    <button type="submit">Fetch Filings</button>
  </form>

  <h2>Company Info</h2>
  <pre id="companyInfo">Company info will appear here...</pre>

  <h2>Accounts Filings (last 20)</h2>
  <ul id="filingsList">
    <li>No filings fetched yet.</li>
  </ul>

  <script>
    const form = document.getElementById("companyForm");
    const companyInfoEl = document.getElementById("companyInfo");
    const filingsListEl = document.getElementById("filingsList");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const companyNumber = e.target.company.value.trim();
      if (!companyNumber) return;

      companyInfoEl.textContent = "Fetching company info...";
      filingsListEl.innerHTML = "<li>Fetching filings...</li>";

      try {
        // 1. Fetch basic company info
        const infoRes = await fetch(`/.netlify/functions/companiesHouse?company=${companyNumber}`);
        const infoData = await infoRes.json();

        if (infoData.error) {
          companyInfoEl.textContent = "Error fetching company info: " + infoData.error;
          filingsListEl.innerHTML = "<li class='error'>Cannot fetch filings.</li>";
          return;
        }

        // Display company info
        companyInfoEl.textContent = `
Name: ${infoData.company_name}
Number: ${infoData.company_number}
Status: ${infoData.company_status}
Registered Office: ${infoData.registered_office_address.address_line_1}, ${infoData.registered_office_address.locality}, ${infoData.registered_office_address.postal_code}
Companies House Page: https://find-and-update.company-information.service.gov.uk/company/${companyNumber}
`;

        // 2. Fetch filings
        const filingsRes = await fetch(`/.netlify/functions/filingHistory?company=${companyNumber}`);
        const filingsData = await filingsRes.json();

        if (filingsData.error) {
          filingsListEl.innerHTML = `<li class="error">Error fetching filings: ${filingsData.error}</li>`;
          return;
        }

        if (!filingsData.items || filingsData.items.length === 0) {
          filingsListEl.innerHTML = "<li>No accounts filings found.</li>";
          return;
        }

        // Display filings list
        filingsListEl.innerHTML = "";
        filingsData.items.forEach(f => {
          const li = document.createElement("li");
          const filingDate = new Date(f.date).toLocaleDateString();
          const filingDescription = f.description || f.type || "Accounts";
          const filingLink = `https://find-and-update.company-information.service.gov.uk/company/${companyNumber}/filing-history/${f.transaction_id}`;

          li.innerHTML = `<strong>${filingDate}:</strong> ${filingDescription} â€” <a href="${filingLink}" target="_blank">View on Companies House</a>`;
          filingsListEl.appendChild(li);
        });

      } catch (err) {
        console.error("Error:", err);
        companyInfoEl.textContent = "Unexpected error fetching company info.";
        filingsListEl.innerHTML = `<li class="error">Unexpected error fetching filings: ${err.message}</li>`;
      }
    });
  </script>
</body>
</html>


