<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Financial AI ‚Äì Draft Statements (Gemini Multimodal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#0b5bd3; --brand2:#0948a9; --bg:#f6f7fb; --card:#fff; --text:#222; --muted:#6b7280; --err:#b00020; }
    * { box-sizing: border-box; }
    body { margin:0; padding:24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    h1,h2,h3 { margin:0 0 12px; color:#0b335b; }
    p { margin: 6px 0 12px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    .card { background:var(--card); border:1px solid #e7e9f0; border-radius: 12px; padding: 18px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .grid { display: grid; gap: 12px; }
    @media (min-width: 720px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    label { font-weight: 600; font-size: 14px; display:block; margin-bottom: 6px; color:#0b335b; }
    input[type="text"], select, textarea, input[type="file"] {
      width: 100%; padding: 10px 12px; border:1px solid #d6dae3; border-radius: 10px; background:#fff; font-size: 15px;
    }
    textarea { min-height: 100px; resize: vertical; }
    .btn-row { display:flex; gap:10px; flex-wrap: wrap; margin-top: 8px; }
    button { appearance: none; border:0; background:var(--brand); color:#fff; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor:pointer; }
    button.secondary { background:#eef3ff; color:#0b335b; border:1px solid #d7e2ff; }
    button:hover { background:var(--brand2); }
    button.secondary:hover { background:#e2ebff; }
    .muted { color:var(--muted); }
    .loading { color:#444; }
    .err { color:var(--err); white-space: pre-wrap; }
    pre { background:#fbfcff; border:1px solid #e7e9f0; padding:12px; border-radius:10px; overflow:auto; white-space: pre-wrap; }
    .hint { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .pill { display:inline-block; padding:4px 8px; background:#eef3ff; border:1px solid #d7e2ff; border-radius:999px; font-size:12px; color:#0b335b; margin-right:6px; }
    .section-title { display:flex; align-items:center; gap:8px; }
    .footer-note { font-size: 12px; color: var(--muted); margin-top: 8px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Financial AI ‚Äì Draft Financial Statements</h1>
  <p class="muted">Upload last year‚Äôs PDF and this year‚Äôs trial balance (Excel). Choose the accounting framework and add notes. Click generate to produce a draft.</p>

  <!-- Step 0: Context -->
  <div class="card">
    <div class="section-title">
      <h2 style="margin:0;">Step 0</h2><span class="pill">Context</span>
    </div>
    <div class="grid grid-2">
      <div>
        <label for="framework">Accounting framework</label>
        <select id="framework">
          <option value="IFRS" selected>IFRS</option>
          <option value="US GAAP">US GAAP</option>
        </select>
      </div>
      <div>
        <label for="companyName">Company name (optional)</label>
        <input id="companyName" type="text" placeholder="e.g., Anglo London Limited" />
      </div>
    </div>
    <div style="margin-top:12px;">
      <label for="notes">Notes / instructions (optional)</label>
      <textarea id="notes" placeholder="Restatements, new standards, one-offs, sections to emphasise, etc."></textarea>
    </div>
  </div>

  <!-- Step 1: Prior-year PDF -->
  <div class="card">
    <div class="section-title">
      <h2 style="margin:0;">Step 1</h2><span class="pill">Prior-year PDF</span>
    </div>
    <div class="grid grid-2">
      <div>
        <label for="priorPdf">Upload prior-year financial statements (PDF)</label>
        <input id="priorPdf" type="file" accept="application/pdf" />
        <div class="hint">This helps the model mirror headings and tone. Optional, but recommended.</div>
      </div>
    </div>
    <div id="priorStatus" class="muted" style="margin-top:10px;">No PDF selected.</div>
  </div>

  <!-- Step 2: Trial balance (Excel) -->
  <div class="card">
    <div class="section-title">
      <h2 style="margin:0;">Step 2</h2><span class="pill">Current-year TB (Excel)</span>
    </div>
    <div class="grid grid-2">
      <div>
        <label for="tbCurrent">Upload current-year trial balance (.xls / .xlsx)</label>
        <input id="tbCurrent" type="file" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
        <div class="hint">A single sheet with account names + amounts works well.</div>
      </div>
    </div>
    <div id="tbStatus" class="muted" style="margin-top:10px;">No TB selected.</div>
  </div>

  <!-- Step 3: Generate -->
  <div class="card">
    <div class="section-title">
      <h2 style="margin:0;">Step 3</h2><span class="pill">Generate</span>
    </div>
    <div class="btn-row">
      <button id="generateBtn">Generate Draft with Gemini</button>
      <button id="clearBtn" class="secondary" type="button">Clear Results</button>
      <button id="previewBtn" class="secondary" type="button" title="Show what will be sent (no AI call)">Preview Payload</button>
    </div>
    <div id="aiOutput" class="muted" style="margin-top:12px;">Draft will appear here‚Ä¶</div>
  </div>

  <!-- Diagnostics -->
  <div class="card">
    <h3 style="margin-bottom:6px;">Diagnostics</h3>
    <pre id="diagnostics" class="muted">No actions yet‚Ä¶</pre>
    <div class="footer-note">If something fails, details will be shown here.</div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const frameworkEl = document.getElementById("framework");
  const companyEl   = document.getElementById("companyName");
  const notesEl     = document.getElementById("notes");

  const priorPdfEl  = document.getElementById("priorPdf");
  const tbEl        = document.getElementById("tbCurrent");

  const priorStatus = document.getElementById("priorStatus");
  const tbStatus    = document.getElementById("tbStatus");

  const generateBtn = document.getElementById("generateBtn");
  const clearBtn    = document.getElementById("clearBtn");
  const previewBtn  = document.getElementById("previewBtn");

  const aiOutput    = document.getElementById("aiOutput");
  const diagnostics = document.getElementById("diagnostics");

  function set(el, html, cls) {
    if (!el) return;
    if (cls !== undefined) el.className = cls;
    el.innerHTML = html;
  }

  function bytesFromB64Len(b64Len) {
    // approximate decoded bytes length
    return Math.round((b64Len * 3) / 4);
  }

  async function fileToBase64(inputEl) {
    const f = inputEl?.files?.[0];
    if (!f) return null;
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onerror = () => reject(new Error("Failed to read file"));
      fr.onload = () => {
        const result = String(fr.result || "");
        const comma = result.indexOf(",");
        const base64 = comma >= 0 ? result.slice(comma + 1) : result;
        resolve({ name: f.name, mimeType: f.type || "", base64 });
      };
      fr.readAsDataURL(f);
    });
  }

  priorPdfEl.addEventListener("change", () => {
    const f = priorPdfEl.files?.[0];
    if (!f) { set(priorStatus, "No PDF selected.", "muted"); return; }
    set(priorStatus, `üìÑ Selected: ${f.name} (${Math.round(f.size/1024)} KB)`, "muted");
  });

  tbEl.addEventListener("change", () => {
    const f = tbEl.files?.[0];
    if (!f) { set(tbStatus, "No TB selected.", "muted"); return; }
    set(tbStatus, `üìä Selected: ${f.name} (${Math.round(f.size/1024)} KB)`, "muted");
  });

  clearBtn.addEventListener("click", () => {
    set(aiOutput, "Draft will appear here‚Ä¶", "muted");
    set(diagnostics, "No actions yet‚Ä¶", "muted");
  });

  async function buildPayload() {
    const framework   = frameworkEl?.value || "IFRS";
    const companyName = companyEl?.value || "";
    const notes       = notesEl?.value || "";

    const priorPdf = await fileToBase64(priorPdfEl);
    const tbCurrent = await fileToBase64(tbEl);

    const files = [];
    if (priorPdf)  files.push({ kind: "priorPdf",  ...priorPdf });
    if (tbCurrent) files.push({ kind: "tbCurrent", ...tbCurrent });

    return { framework, companyName, notes, files };
  }

  previewBtn.addEventListener("click", async () => {
    try {
      const payload = await buildPayload();
      const diag = {
        framework: payload.framework,
        companyName: payload.companyName,
        notesLength: payload.notes.length,
        files: payload.files.map(f => ({
          kind: f.kind, name: f.name, mimeType: f.mimeType,
          approxBytes: bytesFromB64Len(f.base64.length)
        }))
      };
      set(diagnostics, "Preview of payload to be sent (no AI call):\n" + JSON.stringify(diag, null, 2), "muted");
      set(aiOutput, "Preview created. Click Generate to call Gemini.", "muted");
    } catch (err) {
      set(diagnostics, "Preview failed: " + err.message, "err");
    }
  });

  generateBtn.addEventListener("click", async () => {
    try {
      const payload = await buildPayload();

      if (!payload.files.length) {
        set(aiOutput, "<span class='err'>‚ö†Ô∏è Please upload a prior-year PDF and/or a current-year TB (Excel).</span>", "err");
        return;
      }

      const light = {
        framework: payload.framework,
        companyName: payload.companyName,
        notesLength: payload.notes.length,
        files: payload.files.map(f => ({
          kind: f.kind, name: f.name, mimeType: f.mimeType,
          approxBytes: bytesFromB64Len(f.base64.length)
        }))
      };
      set(diagnostics, "Sending JSON to generateStatements:\n" + JSON.stringify(light, null, 2), "muted");
      set(aiOutput, "‚è≥ Uploading and generating draft financial statements‚Ä¶", "loading");

      const res = await fetch("/.netlify/functions/generateStatements", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const raw = await res.text();
      let data = {};
      try { data = JSON.parse(raw); } catch {}

      if (!res.ok) {
        const details = [
          data.error && `Error: ${data.error}`,
          data.details && `Details: ${data.details}`,
          data.modelTried && `Model tried: ${data.modelTried}`,
          data.endpoint && `Endpoint: ${data.endpoint}`,
          data.responseBody && `Response body:\n${data.responseBody}`
        ].filter(Boolean).join("\n");
        set(aiOutput, `<pre class="err">‚ùå Generation failed.\n${details || raw || "No details returned."}</pre>`, "err");
        return;
      }

      set(aiOutput, `<h3>‚úÖ Draft Generated (${data.model || "model unknown"})</h3><pre>${data.output || "No output"}</pre>`);
    } catch (err) {
      set(aiOutput, `<span class="err">‚ùå ${err.message}</span>`, "err");
      set(diagnostics, `Exception: ${err.message}`, "muted");
      console.error("Generate exception:", err);
    }
  });
});
</script>
</body>
</html>








