<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Draft Financial Statements (MVP)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 2rem; background:#f7f9fc; color:#222; }
    h1, h2 { color:#083a7a; }
    .card { background:#fff; padding:1rem 1.25rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin:1rem 0; }
    label { display:block; margin:0.5rem 0 0.25rem; font-weight:600; }
    input, select, button, textarea { width:100%; padding:0.6rem; font-size:1rem; }
    button { background:#0b66c3; color:#fff; border:0; border-radius:6px; cursor:pointer; margin-top:0.75rem; }
    button:hover { background:#0a58a6; }
    .row { display:grid; gap:0.75rem; grid-template-columns:1fr 1fr; }
    .mono { white-space:pre-wrap; background:#f2f4f7; padding:0.75rem; border-radius:6px; overflow:auto; max-height:260px; }
    small { color:#555; }
  </style>
</head>
<body>
  <h1>Draft Financial Statements</h1>
  <p>Steps: 1) Upload prior PDF → 2) Pick standard → 3) Upload trial balances → 4) Generate draft.</p>

  <div class="card">
    <h2>1) Upload Prior-Year Financial Statements (PDF)</h2>
    <form id="priorPdfForm">
      <label>Prior-year PDF</label>
      <input type="file" name="priorPdf" accept=".pdf" required />
      <button type="submit">Extract Prior-Year Style</button>
    </form>
    <div id="priorPreview" class="mono"><small>Preview will appear here…</small></div>
  </div>

  <div class="card">
    <h2>2) Choose Accounting Standard</h2>
    <label>Framework</label>
    <select id="framework">
      <option value="IFRS">IFRS</option>
      <option value="US GAAP">US GAAP</option>
    </select>
  </div>

  <div class="card">
    <h2>3) Upload Trial Balances (Excel)</h2>
    <div class="row">
      <div>
        <label>Prior year TB (Excel)</label>
        <input type="file" id="tbPrior" accept=".xlsx,.xls" required />
      </div>
      <div>
        <label>Current year TB (Excel)</label>
        <input type="file" id="tbCurrent" accept=".xlsx,.xls" required />
      </div>
    </div>
    <button id="parseTbBtn">Read Trial Balances</button>
    <div id="tbPreview" class="mono"><small>TB check will appear here…</small></div>
  </div>

  <div class="card">
    <h2>4) Generate Draft Statements</h2>
    <label>Company name (optional)</label>
    <input type="text" id="companyName" placeholder="e.g. Anglo London Limited"/>
    <label>Notes / special instructions (optional)</label>
    <textarea id="notes" rows="4" placeholder="e.g. Show revenue breakdown; highlight lease liabilities;"></textarea>
    <button id="generateBtn">Generate Draft with Gemini</button>
    <div id="aiOutput" class="mono"><small>Draft will appear here…</small></div>
  </div>

  <script>
    // 1) Upload Prior PDF → extract style/text sample
    document.getElementById("priorPdfForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      document.getElementById("priorPreview").textContent = "Extracting text from prior-year PDF…";
      const res = await fetch("/.netlify/functions/extractPriorPdf", { method:"POST", body: formData });
      const data = await res.json();
      document.getElementById("priorPreview").textContent = data.preview || data.error || "No text found.";
      sessionStorage.setItem("priorText", data.fullText || "");
    });

    // 3) Read Trial Balances (client uploads → server parses)
    document.getElementById("parseTbBtn").addEventListener("click", async () => {
      const prior = document.getElementById("tbPrior").files[0];
      const current = document.getElementById("tbCurrent").files[0];
      if (!prior || !current) {
        alert("Please choose both prior and current year TB files.");
        return;
      }
      const fd = new FormData();
      fd.append("tbPrior", prior);
      fd.append("tbCurrent", current);
      document.getElementById("tbPreview").textContent = "Reading trial balances…";
      const res = await fetch("/.netlify/functions/parseTrialBalances", { method:"POST", body: fd });
      const data = await res.json();
      if (!res.ok) {
        document.getElementById("tbPreview").textContent = data.error || "Error reading TB files.";
        return;
      }
      document.getElementById("tbPreview").textContent = data.summary || "Parsed.";
      // keep parsed rows in sessionStorage for generation
      sessionStorage.setItem("tbParsed", JSON.stringify(data.tbParsed || {}));
    });

    // 4) Generate draft statements with Gemini
    document.getElementById("generateBtn").addEventListener("click", async () => {
      const framework = document.getElementById("framework").value || "IFRS";
      const companyName = document.getElementById("companyName").value || "";
      const notes = document.getElementById("notes").value || "";
      const priorText = sessionStorage.getItem("priorText") || "";
      const tbParsed = sessionStorage.getItem("tbParsed") || "";

      if (!priorText) {
        alert("Please upload the prior-year PDF first.");
        return;
      }
      if (!tbParsed) {
        alert("Please upload and parse the trial balances first.");
        return;
      }

      document.getElementById("aiOutput").textContent = "Generating draft with Gemini…";

      const res = await fetch("/.netlify/functions/generateStatements", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          framework, companyName, notes,
          priorText,
          tbParsed: JSON.parse(tbParsed)
        })
      });
      const data = await res.json();
      document.getElementById("aiOutput").textContent = data.output || data.error || "No output.";
    });
  </script>
</body>
</html>









