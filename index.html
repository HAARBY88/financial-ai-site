<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Draft Financial Statements (MVP)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 2rem; background:#f7f9fc; color:#222; }
    h1, h2 { color:#083a7a; }
    .card { background:#fff; padding:1rem 1.25rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin:1rem 0; }
    label { display:block; margin:0.5rem 0 0.25rem; font-weight:600; }
    input, select, button, textarea { width:100%; padding:0.6rem; font-size:1rem; }
    button { background:#0b66c3; color:#fff; border:0; border-radius:6px; cursor:pointer; margin-top:0.75rem; }
    button:hover { background:#0a58a6; }
    .row { display:grid; gap:0.75rem; grid-template-columns:1fr 1fr; }
    .mono { white-space:pre-wrap; background:#f2f4f7; padding:0.75rem; border-radius:6px; overflow:auto; max-height:260px; }
    small { color:#555; }
    .ok { color:#1f7a1f; }
    .err { color:#b00020; }
  </style>
</head>
<body>
  <h1>Draft Financial Statements</h1>
  <p>Steps: 1) Upload prior PDF → 2) Pick standard → 3) Upload trial balances → 4) Generate draft.</p>

  <!-- 1) Upload Prior-Year PDF (Base64 to Netlify function) -->
  <div class="card">
    <h2>1) Upload Prior-Year Financial Statements (PDF)</h2>
    <label for="priorPdfInput">Prior-year PDF</label>
    <input type="file" id="priorPdfInput" accept=".pdf" />
    <button id="uploadPriorPdfBtn">Extract Prior-Year Style</button>
    <div id="priorPreview" class="mono"><small>Preview will appear here…</small></div>
  </div>

  <!-- 2) Framework -->
  <div class="card">
    <h2>2) Choose Accounting Standard</h2>
    <label for="framework">Framework</label>
    <select id="framework">
      <option value="IFRS">IFRS</option>
      <option value="US GAAP">US GAAP</option>
    </select>
  </div>

  <!-- 3) Trial Balances -->
  <div class="card">
    <h2>3) Upload Trial Balances (Excel)</h2>
    <div class="row">
      <div>
        <label for="tbPrior">Prior year TB (Excel)</label>
        <input type="file" id="tbPrior" name="tbPrior" accept=".xlsx,.xls" />
      </div>
      <div>
        <label for="tbCurrent">Current year TB (Excel)</label>
        <input type="file" id="tbCurrent" name="tbCurrent" accept=".xlsx,.xls" />
      </div>
    </div>
    <button id="parseTbBtn">Read Trial Balances</button>
    <div id="tbPreview" class="mono"><small>TB check will appear here…</small></div>
  </div>

  <!-- 4) Generate -->
  <div class="card">
    <h2>4) Generate Draft Statements</h2>
    <label for="companyName">Company name (optional)</label>
    <input type="text" id="companyName" placeholder="e.g. Anglo London Limited"/>
    <label for="notes">Notes / special instructions (optional)</label>
    <textarea id="notes" rows="4" placeholder="e.g. Show revenue breakdown; highlight lease liabilities;"></textarea>
    <button id="generateBtn">Generate Draft with Gemini</button>
    <div id="aiOutput" class="mono"><small>Draft will appear here…</small></div>
  </div>

  <script>
    /** Utility: file -> base64 string */
    async function fileToBase64(file) {
      const arrayBuffer = await file.arrayBuffer();
      let binary = "";
      const bytes = new Uint8Array(arrayBuffer);
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    // 1) Upload prior PDF (send Base64 body; do NOT set Content-Type)
    document.getElementById("uploadPriorPdfBtn").addEventListener("click", async () => {
      const input = document.getElementById("priorPdfInput");
      const previewDiv = document.getElementById("priorPreview");

      if (!input.files || !input.files[0]) {
        previewDiv.innerHTML = "<span class='err'>Please choose a PDF file.</span>";
        return;
      }

      try {
        previewDiv.textContent = "Uploading and extracting…";
        const base64 = await fileToBase64(input.files[0]);

        const res = await fetch("/.netlify/functions/extractPriorPdf", {
          method: "POST",
          body: base64
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          previewDiv.innerHTML = `<span class='err'>${data.error || "Upload failed."}</span>`;
          return;
        }

        const previewText = data.preview || data.extractedText || "";
        const fullText = data.fullText || data.extractedText || "";
        if (!previewText && !fullText) {
          previewDiv.innerHTML = "<span class='err'>No text extracted from PDF.</span>";
          return;
        }

        previewDiv.innerHTML = `<span class='ok'>OK</span>\n\n${(previewText || fullText).slice(0, 1500)}${(previewText || fullText).length > 1500 ? "…" : ""}`;
        sessionStorage.setItem("priorText", fullText || previewText);
      } catch (err) {
        previewDiv.innerHTML = `<span class='err'>Error: ${err.message}</span>`;
      }
    });

    // 3) Read Trial Balances (multipart FormData) — makes sure names are tbPrior & tbCurrent
    document.getElementById("parseTbBtn").addEventListener("click", async () => {
      const priorFile = document.getElementById("tbPrior").files[0];
      const currentFile = document.getElementById("tbCurrent").files[0];
      const tbDiv = document.getElementById("tbPreview");

      // Front-end guard (stops common “Both tbPrior and tbCurrent required”)
      if (!priorFile || !currentFile) {
        tbDiv.innerHTML = "<span class='err'>Please choose both prior and current year TB files.</span>";
        return;
      }

      const fd = new FormData();
      fd.append("tbPrior", priorFile);   // IMPORTANT: exact field name
      fd.append("tbCurrent", currentFile);

      tbDiv.textContent = "Reading trial balances…";
      try {
        const res = await fetch("/.netlify/functions/parseTrialBalances", {
          method: "POST",
          body: fd
        });
        const data = await res.json().catch(()=> ({}));

        if (!res.ok) {
          // Show what the server received to spot field-name typos
          const extra = data.receivedFields ? `\n\nReceived fields: ${data.receivedFields}` : "";
          tbDiv.innerHTML = `<span class='err'>${data.error || "Error reading TB files."}${extra}</span>`;
          return;
        }

        tbDiv.textContent = data.summary || "Parsed.";
        sessionStorage.setItem("tbParsed", JSON.stringify(data.tbParsed || {}));
      } catch (err) {
        tbDiv.innerHTML = `<span class='err'>Error: ${err.message}</span>`;
      }
    });

    // 4) Generate draft statements with Gemini
    document.getElementById("generateBtn").addEventListener("click", async () => {
      const framework = document.getElementById("framework").value || "IFRS";
      const companyName = document.getElementById("companyName").value || "";
      const notes = document.getElementById("notes").value || "";
      const priorText = sessionStorage.getItem("priorText") || "";
      const tbParsed = sessionStorage.getItem("tbParsed") || "";

      const outDiv = document.getElementById("aiOutput");

      if (!priorText) {
        outDiv.innerHTML = "<span class='err'>Please upload the prior-year PDF first.</span>";
        return;
      }
      if (!tbParsed) {
        outDiv.innerHTML = "<span class='err'>Please upload and read the trial balances first.</span>";
        return;
      }

      outDiv.textContent = "Generating draft with Gemini…";

      try {
        const res = await fetch("/.netlify/functions/generateStatements", {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            framework, companyName, notes,
            priorText,
            tbParsed: JSON.parse(tbParsed)
          })
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) {
          outDiv.innerHTML = `<span class='err'>${data.error || "Generation failed."}</span>`;
          return;
        }
        outDiv.textContent = data.output || "No output.";
      } catch (err) {
        outDiv.innerHTML = `<span class='err'>Error: ${err.message}</span>`;
      }
    });
  </script>
</body>
</html>










